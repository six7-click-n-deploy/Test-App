# GitHub Actions Workflow: Packer checks
# Runs on `push`, pull requests, and created releases.
# For pull requests and checks the following steps are executed:
# - Checkout: the repository is checked out.
# - Setup Packer: `hashicorp/setup-packer` installs Packer on the runner.
# In the `packer` working directory the following commands are executed to validate templates:
# - `packer init`        -> initializes any modules or plugin requirements
# - `packer fmt -check`  -> checks that Packer templates are properly formatted
# - `packer validate`    -> validates the Packer template(s)

name: 'Packer'

on:
  push:
  pull_request:
    branches: [ "main" ]
  release:
    types: [created]

permissions:
  contents: read

jobs:
  packer:
    name: 'Packer'
    runs-on: ubuntu-latest
    environment: production

    defaults:
      run:
        shell: bash

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Packer
      env:
        PACKER_VERSION: '1.9.2'
      run: |
        set -eux
        sudo apt-get update
        sudo apt-get install -y unzip curl
        curl -fsSL -o packer.zip "https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_amd64.zip"
        rm -f packer
        unzip -o packer.zip
        sudo mv -f packer /usr/local/bin/packer
        rm -f packer.zip
        packer version

    - name: Packer Init
      run: packer init
      working-directory: packer

    - name: Packer Format
      run: packer fmt -check
      working-directory: packer

    - name: Packer Validate
      run: packer validate
      working-directory: packer
