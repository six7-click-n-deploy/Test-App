# GitHub Actions Workflow: Terraform checks
# Runs on `push`, pull requests, and created releases.
# For pull requests and checks the following steps are executed:
# - Checkout: the repository is checked out.
# - Setup Terraform: `hashicorp/setup-terraform` installs Terraform and configures the CLI
#   using the token from the `TF_API_TOKEN` secret.
# In the `terraform` working directory the following commands are checked:
# - `terraform init -backend=false`  -> initializes the directory without a remote backend
# - `terraform fmt -check`          -> checks that all `.tf` files are properly formatted
# - `terraform validate`           -> validates the Terraform configuration
# On pushes to the `main` branch `terraform apply` is intended to run (requires
# a remote backend configuration in `terraform/main.tf` and a set `TF_API_TOKEN`).

name: 'Terraform'

# Only by pull requests or creating new releases

on:
  push:
  pull_request:
    branches: [ "main" ]
  release:
    types: [created]

permissions:
  contents: read

jobs:
  terraform:
    name: 'Terraform'
    runs-on: ubuntu-latest
    environment: production

    # Use the Bash shell regardless whether the GitHub Actions runner is ubuntu-latest, macos-latest, or windows-latest
    defaults:
      run:
        shell: bash

    steps:
    # Checkout the repository to the GitHub Actions runner
    - name: Checkout
      uses: actions/checkout@v4

    # Install the latest version of Terraform CLI 
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v1

    # Initialize a new or existing Terraform working directory by creating initial files, loading any remote state, downloading modules, etc.
    - name: Terraform Init
      run: terraform init -backend=false
      working-directory: terraform

    # Checks that all Terraform configuration files adhere to a canonical format
    - name: Terraform Format
      run: terraform fmt -check
      working-directory: terraform

    # Validates the Terraform configuration files
    - name: Terraform Validate
      run: terraform validate
      working-directory: terraform
